name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    strategy:
      matrix:
        # 启用跨平台验证，覆盖Wails核心支持的系统
        os: [ubuntu-latest, windows-latest, macos-latest]
      # 任一平台失败立即终止，快速反馈问题
      fail-fast: true

    runs-on: ${{ matrix.os }}
    # 为不同系统设置标识，方便后续步骤区分
    env:
      WAILS_VERSION: v2.8.0  # 锁定Wails版本，避免版本漂移

    steps:
    - uses: actions/checkout@v4
      with:
        # 拉取完整历史，避免测试/构建时缺少依赖
        fetch-depth: 0

    # ===== 新增：缓存优化（核心提升CI效率）=====
    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/go/pkg/mod
          %LocalAppData%\go\pkg\mod  # Windows路径
          ~/Library/Caches/go-build # macOS路径
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Cache Node modules
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-node-

    # ===== 基础环境配置（优化版本锁定和系统适配）=====
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        # 启用Go模块缓存，加速依赖下载
        cache: true

    - name: Set up Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        # 启用Node缓存
        cache: 'npm'

    - name: Install Linux Dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update -y
        sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
        # 验证依赖安装成功
        dpkg -l libgtk-3-dev libwebkit2gtk-4.1-dev

    - name: Install macOS Dependencies
      if: runner.os == 'macOS'
      run: |
        # macOS下Wails依赖的webkit已内置，仅验证Xcode命令行工具
        xcode-select --install || true

    - name: Install Windows Dependencies
      if: runner.os == 'Windows'
      run: |
        # Windows下Wails依赖的WebView2，Wails会自动安装，此处仅验证Go/Node环境
        go version
        node --version

    - name: Install Wails
      run: go install github.com/wailsapp/wails/v2/cmd/wails@${{ env.WAILS_VERSION }}
    # 验证Wails安装成功
    - name: Verify Wails Installation
      run: wails version

    # ===== 核心CI步骤（新增校验逻辑）=====
    - name: Install Project Dependencies
      run: make install-deps

    - name: Run Backend Tests (with coverage)
      run: |
        # 输出测试覆盖率，并存为文件（方便后续上传）
        make test-backend -v || exit 1
        # 示例：如果是Go测试，补充覆盖率输出（根据你的makefile调整）
        go test ./... -coverprofile=coverage.out -covermode=atomic

    - name: Build Application
      run: make build -v

    # ===== 新增：验证构建产物是否存在 =====
    - name: Verify Build Artifact
      run: |
        # 根据不同系统检查产物，需根据你的Wails项目输出路径调整
        if [ "${{ runner.os }}" = "Linux" ]; then
          # 假设Linux产物在build/linux下
          ls -la build/linux/ && [ -f build/linux/your-app-name ] || { echo "Linux产物缺失"; exit 1; }
        elif [ "${{ runner.os }}" = "Windows" ]; then
          # Windows产物通常是exe文件
          dir build\windows\ && if not exist build\windows\your-app-name.exe (echo Windows产物缺失 && exit 1)
        elif [ "${{ runner.os }}" = "macOS" ]; then
          # macOS产物通常是app包
          ls -la build/darwin/ && [ -d build/darwin/your-app-name.app ] || { echo "macOS产物缺失"; exit 1; }
        fi

    # ===== 可选：上传测试覆盖率报告（方便查看）=====
    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-${{ runner.os }}
        path: coverage.out
      # 测试失败也上传报告
      if: always()